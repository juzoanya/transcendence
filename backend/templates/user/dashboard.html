<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>User Profile</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<style>
		.not-visible {
			display: none;
		}

		.result-card {
			box-shadow: 0 8px 8px 0 rgba(0,0,0,0.25);
			transition: 0.5s;
			border-radius: 7px;
			padding: 15px 15px;
		}

		.item {
			text-decoration: none;
		}

		.user-avatar {
			width: 50px;
			height: 50px;
			border-radius: 50%;
		}
	</style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-light">
	<div class="container-fluid">
	  	<!-- Welcome Section -->
	  	<span class="navbar-text mr-auto">Hello, {{user.first_name}}</span>
	  
	  	<!-- Profile Section -->
		<div class="dropdown">
			<button class="btn btn-outline-secondary dropdown-toggle" type="button" id="profileDropdown" data-bs-toggle="dropdown" aria-expanded="false">
				Profile
			</button>
			<ul class="dropdown-menu" aria-labelledby="profileDropdown">
				<li><a class="dropdown-item" href="profile/{{ request.user.id }}">View Profile</a></li>
				<li><a class="dropdown-item" href="#">Edit Profile</a></li>
				<li><hr class="dropdown-divider"></li>
				<li><a class="dropdown-item" href="#" onclick="logout()">Logout</a></li>
			</ul>
		</div>
  
	  	<!-- Logout Button -->
	  	<button class="btn btn-outline-danger logout-button ml-2" onclick="logout()">Logout</button>
	</div>
</nav>

<div class="container mt-4">
	<div class="row justify-content-center">
		<div class="col-md-4">
			<form id="search-form" autocomplete="off">
				<div class="input-group mb-3">
					<input type="text" id="search-input" class="form-control" placeholder="Search users...">
					<button class="btn btn-primary" type="submit">Search</button>
				</div>
			</form>
			<div id="search-results" class="result-card not-visible"></div>
		</div>
	</div>

	
</div>

<!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>

<script>

	const searchForm = document.getElementById('search-form');
	const searchInput = document.getElementById('search-input');
	const searchResults = document.getElementById('search-results');
	const csrf = getCookie('csrftoken');

	const sendSearchData = (userName) => {
		$.ajax({
			type: 'POST',
			url: 'search-user',
			data: {
				'userName': userName
			},
			headers: {
				'X-CSRFToken': csrf
			},
			success: (res)=> {
				const data = res.data
				if (Array.isArray(data)) {
					searchResults.innerHTML = ""
					data.forEach(userName=> {
						searchResults.innerHTML += `
							<div class="row mt-2 mb-2">
								<div class="col-2">
									<img src="${userName.pk}" class="user-avatar">
								</div>
								<div class="col-8">
									<a href="profile/${userName.pk}"><h5>${userName.username}</h5></a>
									<p class="text-muted">${userName.first_name} ${userName.last_name}</p>
								</div>
								<div class="col-2">
									<button type="button" class="btn btn-primary my-button" id="friend-request">+</button>
								</div>
							</div>
						`
					})
					// Attach event listener to the buttons with class "friend-request"
					const friendRequestButtons = document.querySelectorAll('.friend-request');
					friendRequestButtons.forEach(button => {
						button.addEventListener('click', function() {
							const username = this.getAttribute('data-username');
							sendFriendRequest(username); // Call function to send friend request
						});
					});
				} else {
					if (searchInput.value.length > 0) {
						searchResults.innerHTML = `<b>${data}</b>`
					} else {
						searchResults.classList.add('not-visible')
					}
				}
			},
			error: (err)=> {
				console.log(err)
			}
		})
	}

	searchInput.addEventListener('keyup', e=>{
		if (searchResults.classList.contains('not-visible')){
			searchResults.classList.remove('not-visible');
		}
		sendSearchData(e.target.value)
	})

	function sendFriendRequest(username) {
    // Send POST request to Django backend
    fetch('friend-request', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ username: username })
    })
    .then(response => {
        if (response.ok) {
            // Handle success response if needed
        } else {
            // Handle error response if needed
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

	function getCookie(name) {
		let cookieValue = null;
		if (document.cookie && document.cookie !== '') {
			const cookies = document.cookie.split(';');
			for (let i = 0; i < cookies.length; i++) {
				const cookie = cookies[i].trim();
				if (cookie.substring(0, name.length + 1) === (name + '=')) {
					cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
					break;
				}
			}
		}
		return cookieValue;
	}

	function logout() {
		window.location.href = 'logout';
	}

		// // document.addEventListener('DOMContentLoaded', function() {
	//     const searchForm = document.getElementById('search-form');
	//     const searchInput = document.getElementById('search-input');
	//     const searchResults = document.getElementById('search-results');

	//     searchForm.addEventListener('submit', function(event) {
	//         event.preventDefault();
	//         const searchTerm = searchInput.value.trim();
	//         if (searchTerm !== '') {
	//             searchUsers(searchTerm);
	//         }
	//     });

	//     function searchUsers(searchTerm) {
	//         fetch(`/search_users/?search=${encodeURIComponent(searchTerm)}`)
	//         .then(response => {
	//             if (response.ok) {
	//                 return response.json();
	//             } else {
	//                 throw new Error('Failed to search users');
	//             }
	//         })
	//         .then(data => {
	//             displaySearchResults(data);
	//         })
	//         .catch(error => {
	//             console.error('Error searching users:', error);
	//         });
	//     }

	//     function displaySearchResults(users) {
	//         searchResults.innerHTML = '';
	//         if (users.length === 0) {
	//             searchResults.innerHTML = '<p>No users found.</p>';
	//         } else {
	//             users.forEach(user => {
	//                 const userDiv = document.createElement('div');
	//                 userDiv.innerHTML = `
	//                     <p>${user.username}</p>
	//                     <button class="send-request-btn" data-user-id="${user.id}">Send Friend Request</button>
	//                 `;
	//                 searchResults.appendChild(userDiv);
	//             });
	//         }
	//     }

	//     const sendRequestButtons = document.querySelectorAll('.send-request-btn');

	//     sendRequestButtons.forEach(button => {
	//         button.addEventListener('click', function() {
	//             const toUserId = this.dataset.userId;
	//             fetch(`/send_friend_request/${toUserId}/`, {
	//                 method: 'POST',
	//                 headers: {
	//                     'X-CSRFToken': getCookie('csrftoken')
	//                 }
	//             })
	//             .then(response => {
	//                 if (response.ok) {
	//                     // Friend request sent successfully
	//                     // You can update UI accordingly
	//                     console.log('Friend request sent');
	//                 } else {
	//                     console.error('Failed to send friend request');
	//                 }
	//             })
	//             .catch(error => console.error('Error sending friend request:', error));
	//         });
	//     });

	//     // Function to get CSRF token from cookies
	//     function getCookie(name) {
	//         let cookieValue = null;
	//         if (document.cookie && document.cookie !== '') {
	//             const cookies = document.cookie.split(';');
	//             for (let i = 0; i < cookies.length; i++) {
	//                 const cookie = cookies[i].trim();
	//                 if (cookie.substring(0, name.length + 1) === (name + '=')) {
	//                     cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
	//                     break;
	//                 }
	//             }
	//         }
	//         return cookieValue;
	//     }
	// });

</script>
</body>
</html>
